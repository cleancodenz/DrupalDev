<?php 
/**
 * @file
 * A node module that defines a node type: .
 */


/**
 * Implements hook_help.
 *
 * Displays help and module information.
 *
 * @param path
 *   Which path of the site we're using to display help
 * @param arg
 *   Array that holds the current path as returned from arg() function
 */

function ccruby_help($path, $arg) {

}



/**
 * @name ccruby_meun 
 * @{
 */

/*
 *hook_menu_alter
*/
function ccruby_menu_alter(&$items)
{
  //items when user logged in
  $items['user/logout']['menu_name'] ='secondary_top';

  // must remove original one, it can only have one
  if (array_key_exists('user/%user',$items))
  {
    unset($items['user/%user']);
  }
  
  $items['user/%user_uid_optional'] = array(
      'title' => 'My account',
      'title callback' => 'ccruby_user_menu_title',
      'title arguments' => array(1),
      'page callback' => 'user_view_page',
      'page arguments' => array(1),
      'access callback' => 'user_view_access',
      'access arguments' => array(1),
      'menu_name' => 'secondary_top',
  );
  
  
  // items for not logged in

  //get the titile back by making it a normal menu item
  // need manual change to move it to top level
  $items['user/login']['type'] = MENU_NORMAL_ITEM;
  $items['user/login']['weight'] =10;
  $items['user/login']['menu_name'] ='secondary_top';

  //get the titile back by making it a normal menu item
  // need manual change to move it to top level
  $items['user/register']['type'] = MENU_NORMAL_ITEM;
  $items['user/register']['title'] ='Sign up';
  $items['user/register']['weight'] =15;
  $items['user/register']['menu_name'] ='secondary_top';

  
  // user navigation menu
  if (array_key_exists('user/%user/cancel',$items))
  {
    unset($items['user/%user/cancel']);
  }

  if (array_key_exists('user/%user/edit',$items))
  {
    unset($items['user/%user/edit']);
  }
  
  $items['user/%user_uid_optional/edit'] = array(
      'title' => 'Edit',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('user_profile_form', 1),
      'access callback' => 'user_edit_access',
      'access arguments' => array(1),
      'file' => drupal_get_path('module', 'user').'/user.pages.inc',
      'menu_name' => 'ccrubyusernavigation',
      'weight'=>10,
  );
  
  $items['user/%user_uid_optional/cancel'] = array(
      'title' => 'Cancel account',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('user_cancel_confirm_form', 1),
      'access callback' => 'user_cancel_access',
      'access arguments' => array(1),
      'file' => drupal_get_path('module', 'user').'/user.pages.inc',
      'menu_name' => 'ccrubyusernavigation',
      'weight'=>20,
  );
  
 
}

/**
 * Menu item title callback for the 'user' path.
 *
 * expected to see "Hello user name".
 */
function ccruby_user_menu_title() {
  global $user;
  return 'Hello '.format_username($user);
}


/**
 * Implements hook_menu().
 *
 * We are providing a default page to illustrate the use of our custom node view mode that will
 * live at http://example.com/?q=examples/node_example
 *


 function ccruby_menu() {


 }

 */

/**
 * @} End of "name ccruby_menu".
 */


/**
 * @name ccruby_block change navigation contents when different mainmenu activated.
 * @{
 */

/**
 * Implements hook_block_info().
 */
function ccruby_block_info() {

  $blocks['navigation'] =array(
      'info' => t('CCRuby Navigation'),
      // Menu blocks can't be cached because each menu item can have
      // a custom access callback. menu.inc manages its own caching.
      'cache' => DRUPAL_NO_CACHE,
  );
   
  return $blocks;

}


/**
 * Implements hook_block_view().
 *
 * Generate a block with a promotional link to Drupal.org and
 * all ccruby menu blocks.
 */
function ccruby_block_view($delta = '') {

  $block = array();
  switch ($delta) {
    case 'navigation':
      $block['subject'] = NULL;
      $block['content'] = _ccruby_get_navigation();
      return $block;
    default:
      break;
  }
}

function _ccruby_get_navigation()
{
  if(user_is_logged_in())
  {
    // to get current router item
    $router_item = menu_get_item();

    if ($router_item['map'] && count($router_item['map'])>0)
    {
      switch ($router_item['map'][0]) {
        case 'user':
          $tree = menu_tree_page_data('ccrubyusernavigation');
          break;
        default:
          $tree =  menu_tree_page_data('main-menu');
        break;
      }
    }

    return  menu_tree_output($tree);
  }
  return '';

}


/**
 * @} End of "name ccruby_block".
 */
